<?xml version="1.0"?>

<project name="genedb-query" default="query-fulljar" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">

  <dirname property="imported.basedir.query" file="${ant.file.genedb-query}"/>

  <import file="${imported.basedir.query}/../genedb-libs/build.xml" />
  <import file="${imported.basedir.query}/../genedb-util/build.xml" />
  <import file="${imported.basedir.query}/../genedb-db/build.xml" />

  <property name="genedb-query.jar"
      value="${imported.basedir.query}/${dist.dir}/genedb-query.jar"/>
  <property name="query.iajc-timestamp" value="${imported.basedir.query}/${build.dir}/iajc_run"/>
  <property name="query.ivy-timestamp" value="${imported.basedir.query}/${lib.dir}/ivy.timestamp.txt"/>

  <path id="query-classpath">
    <fileset dir="${imported.basedir.query}/lib">
      <include name="*.jar"/>
    </fileset>
  </path>

  <path id="query-tests-classpath">
    <path refid="query-classpath"/>
  	<pathelement location="${imported.basedir.query}/test"/>
  	<pathelement location="${imported.basedir.query}/${classes.dir}"/>
    <pathelement location="${imported.basedir.query}/${test-classes.dir}"/>
  </path>


  <target name="init-query" description="Create full JAR file">
    <init-target project="query" />
  </target>

  <target name="query-fulljar" depends="query-check-jar" unless="query.jar-uptodate">
    <jar-target project="query" />
  </target>

  <target name="query-check-jar" depends="query-iajc">
     <uptodate property="query.jar-uptodate" targetfile="${genedb-query.jar}">
        <srcfiles dir="${imported.basedir.query}/${classes.dir}" includes="**" />
     </uptodate>
  </target>

  <target name="query-iajc" depends="query-compile" unless="query.iajc-uptodate">
    <echo message="query.jar-uptodate = ${query.jar-uptodate}" />
    <iajc-target project="query" />
   </target>

  <target name="query-check-timestamp-exists">
      <available property="query.timestamp-exists" file="${imported.basedir.query}/${build.dir}/timestamp.txt" />
  </target>

  <target name="query-check-uptodate" depends="query-check-timestamp-exists" if="query.timestamp-exists">
    <uptodate property="query.uptodate" targetfile="${imported.basedir.query}/${build.dir}/timestamp.txt">
        <srcfiles dir="${imported.basedir.query}/src" />
    </uptodate>
  </target>

  <target name="query-compile" depends="query-populate-lib, query-populate-db, query-check-uptodate" unless="query.uptodate">
    <compile-target project="query" />
    <iajc-target project="query" />
    <touch file="${imported.basedir.query}/${build.dir}/timestamp.txt"/>
  </target>

   <target name="genedb-query-tests" depends="query-compile">
     <tests-target project="query"/>
   </target>

  <target name="query-populate-db" depends="db-fulljar">
    <copy file="${genedb-db.jar}" todir="${imported.basedir.query}/lib" />
  </target>

  <target name="query-populate-lib" depends="check.query-lib-uptodate" unless="query.lib-uptodate">
    <populate directory="genedb-query" />
  	
  	<!-- 
  		gv1 - hack to include dependencies needed by unit tests, which are otherwise deleted prior to build 
  		@TODO art suggesed we should find out why these dependencies are here in the first place
  	--> 
  	<copy file="${basedir}/../genedb-libs/lib/biojava/biojava-1.6.jar" todir="${imported.basedir.query}/lib" />
  	<copy file="${basedir}/../genedb-libs/lib/biojava/bytecode-0.91.jar" todir="${imported.basedir.query}/lib" />
  	<copy file="${basedir}/../genedb-util/ant-build/dist/genedb-util.jar" todir="${imported.basedir.query}/lib" />
  </target>

  <target name="check.query-lib-uptodate" depends="init-query">
    <uptodate property="query.lib-uptodate" srcfile="${imported.basedir.query}/ivy.xml" targetfile="${imported.basedir.query}${query.ivy-timestamp}" />
  </target>

  <target name="query-clean">
     <clean-target project="query" /> 
  </target>

</project>
